<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>MP4v2 2.0.0 PROJECT_name: example/provider/provider.c</title>
    <link href="project.css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="sitebanner">
    <div id="home">
        <a href="http://code.google.com/p/mp4v2"></a>
    </div>
    <div id="title">
        PROJECT_name: example/provider/provider.c
    </div>
    <div id="menu">
        <ul>
            <li><a href="http://code.google.com/p/mp4v2">MP4v2 Home</a></li>
            <li><a href="../index.html">Documentation</a></li>
            <li class="active">API Reference</li>
        </ul>
    </div>
</div>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>example/provider/provider.c</h1><div class="fragment"><pre class="fragment"><span class="comment">/* This example makes use of the MP4FileProvider API to use custom file</span>
<span class="comment"> * input/output routines.</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;mp4v2/mp4v2.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>

<span class="comment">/*****************************************************************************/</span>

<span class="keyword">static</span> <span class="keywordtype">void</span>* my_open( <span class="keyword">const</span> <span class="keywordtype">char</span>* name, <a name="a0"></a><a class="code" href="group__mp4__file.html#gafdb6cfe7fa59c5317846ffc56f42e81c" title="Enumeration of file modes for custom file provider.">MP4FileMode</a> mode )
{
    <span class="keyword">const</span> <span class="keywordtype">char</span>* om;
    <span class="keywordflow">switch</span>( mode ) {
        <span class="keywordflow">case</span> <a name="a1"></a><a class="code" href="group__mp4__file.html#ggad409ae4e64c51d2e831968b5adcb3711a92dc5629e6fc20c2b7f3436495a0ad5b" title="file may be read">FILEMODE_READ</a>:     om = <span class="stringliteral">&quot;rb&quot;</span>;  <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a name="a2"></a><a class="code" href="group__mp4__file.html#ggad409ae4e64c51d2e831968b5adcb3711a7b48e7deef54a298274319e8dae11405" title="file may be read/written">FILEMODE_MODIFY</a>:   om = <span class="stringliteral">&quot;r+b&quot;</span>; <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a name="a3"></a><a class="code" href="group__mp4__file.html#ggad409ae4e64c51d2e831968b5adcb3711aac9ceaf0626526fabf37ef5aecca9bbc" title="file will be created/truncated for read/write">FILEMODE_CREATE</a>:   om = <span class="stringliteral">&quot;w+b&quot;</span>; <span class="keywordflow">break</span>;

        <span class="keywordflow">case</span> <a name="a4"></a><a class="code" href="group__mp4__file.html#ggad409ae4e64c51d2e831968b5adcb3711a36fc6f169700cbc8a04264f2237edc41" title="undefined">FILEMODE_UNDEFINED</a>:
        <span class="keywordflow">default</span>:
            om = <span class="stringliteral">&quot;rb&quot;</span>;
            <span class="keywordflow">break</span>;
    }

    <span class="keywordflow">return</span> fopen( name, om );
}

<span class="keyword">static</span> <span class="keywordtype">int</span> my_seek( <span class="keywordtype">void</span>* handle, int64_t pos )
{
    <span class="keywordflow">return</span> fseeko( (FILE*)handle, pos, SEEK_SET ) != 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> my_read( <span class="keywordtype">void</span>* handle, <span class="keywordtype">void</span>* buffer, int64_t size, int64_t* nin, int64_t maxChunkSize )
{
    <span class="keywordflow">if</span>( fread( buffer, size, 1, (FILE*)handle ) != 1)
        <span class="keywordflow">return</span> 1;
    *nin = size;
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> my_write( <span class="keywordtype">void</span>* handle, <span class="keyword">const</span> <span class="keywordtype">void</span>* buffer, int64_t size, int64_t* nout, int64_t maxChunkSize )
{
    <span class="keywordflow">if</span>( fwrite( buffer, size, 1, (FILE*)handle ) != 1)
        <span class="keywordflow">return</span> 1;
    *nout = size;
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> my_close( <span class="keywordtype">void</span>* handle )
{
    <span class="keywordflow">return</span> fclose( (FILE*)handle ) != 0;
}

<span class="comment">/*****************************************************************************/</span>

<span class="keywordtype">int</span> main( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv )
{
    <span class="keywordflow">if</span>( argc != 2 ) {
        printf( <span class="stringliteral">&quot;usage: %s file.mp4\n&quot;</span>, argv[0] );
        <span class="keywordflow">return</span> 1;
    }

    <span class="comment">/* populate data structure with custom functions.</span>
<span class="comment">     * safe to put on stack as it will be immediately copied internally.</span>
<span class="comment">     */</span>
    <a name="_a5"></a><a class="code" href="struct_m_p4_file_provider__s.html" title="Structure of functions implementing custom file provider.">MP4FileProvider</a> provider;

    provider.<a name="a6"></a>open  = my_open;
    provider.<a name="a7"></a>seek  = my_seek;
    provider.<a name="a8"></a>read  = my_read;
    provider.<a name="a9"></a>write = my_write;
    provider.<a name="a10"></a>close = my_close;

    <span class="comment">/* open file for read */</span>
    MP4FileHandle file = <a name="a11"></a><a class="code" href="group__mp4__file.html#gad244931e122a46370c0c33842fef9b71" title="Read an existing mp4 file.">MP4ReadProvider</a>( argv[1], 0, &amp;provider );
    <span class="keywordflow">if</span>( file == <a name="a12"></a><a class="code" href="group__mp4__general.html#gafa387d447016a2c4fb1bb7e70b6e3b32" title="Constant: invalid MP4FileHandle.">MP4_INVALID_FILE_HANDLE</a> ) {
        printf( <span class="stringliteral">&quot;MP4Read failed\n&quot;</span> );
        <span class="keywordflow">return</span> 1;
    }

    <span class="comment">/* dump file contents */</span>
    <span class="keywordflow">if</span>( !<a name="a13"></a><a class="code" href="group__mp4__file.html#ga37be2b29448d5d453f3e7b0857f7cb3d" title="Dump mp4 file contents as ASCII either to stdout or the log callback (see MP4SetLogCallback)...">MP4Dump</a>( file, stdout, 0 ))
        printf( <span class="stringliteral">&quot;MP4Dump failed\n&quot;</span> );

    <span class="comment">/* cleanup and close */</span>
    <a name="a14"></a><a class="code" href="group__mp4__file.html#ga484d26d892b561ab0a95f9ce79036dfa" title="Close an mp4 file.">MP4Close</a>( file );

    <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<div class="footer">
    <div>
        generated on Sun May 20 21:18:55 2012 for <b>MP4v2 (2.0.0)</b>
        by&nbsp;<a href="http://www.doxygen.org">Doxygen</a> 1.6.3
    </div>
</div>
</body>
</html>
